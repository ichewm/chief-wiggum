#!/usr/bin/env bash
# Monitor active Chief Wiggum workers

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"
source "$WIGGUM_HOME/lib/defaults.sh"
source "$WIGGUM_HOME/lib/worker-lifecycle.sh"

show_help() {
    cat << EOF
wiggum monitor - Monitor active worker logs

Usage: wiggum monitor [mode]

Modes:
  combined            Show all workers in one stream (default)
  split               Show each worker separately
  status              Continuous status updates

Options:
  -h, --help          Show this help message

Description:
  Monitor the output and progress of active workers in real-time.

  - combined: Tails the combined workers.log file
  - split: Refreshes every 2 seconds showing last 10 lines per worker
  - status: Runs 'wiggum status' every 2 seconds via watch

Examples:
  wiggum monitor           # Show combined output (default)
  wiggum monitor split     # Show each worker separately
  wiggum monitor status    # Watch status updates

EOF
}

# Parse options
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    show_help
    exit 0
fi

# Check for active workers using shared library
has_active_workers=false
if [ -d "$RALPH_DIR/workers" ]; then
    # Use scan_active_workers to check for running workers
    while read -r pid task_id worker_id; do
        if [ -n "$pid" ]; then
            has_active_workers=true
            break
        fi
    done < <(scan_active_workers "$RALPH_DIR")
fi

if [ "$has_active_workers" = false ]; then
    echo "No active workers found. Run 'wiggum run' first."
    exit 1
fi

echo "=== Monitoring Chief Wiggum Workers ==="
echo "Press Ctrl+C to stop"
echo

case "${1:-combined}" in
    combined)
        # Show all worker output combined
        tail -f "$RALPH_DIR/logs/workers.log"
        ;;

    split)
        # Show each worker's latest output
        while true; do
            clear
            for worker_dir in "$RALPH_DIR/workers"/worker-*; do
                if [ -f "$worker_dir/worker.log" ]; then
                    worker_name=$(basename "$worker_dir")
                    echo "=== $worker_name ==="
                    tail -10 "$worker_dir/worker.log" 2>/dev/null
                    echo
                fi
            done
            sleep 2
        done
        ;;

    status)
        # Continuous status updates
        watch -n 2 wiggum-status
        ;;

    *)
        echo "Unknown mode: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
