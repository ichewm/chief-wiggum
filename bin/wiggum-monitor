#!/usr/bin/env bash
# Monitor active Chief Wiggum workers
set -euo pipefail

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"
source "$WIGGUM_HOME/lib/core/exit-codes.sh"
source "$WIGGUM_HOME/lib/core/defaults.sh"
source "$WIGGUM_HOME/lib/worker/worker-lifecycle.sh"

# Resolve the actual script location (follow symlinks)
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
SOURCE_ROOT="$(dirname "$SCRIPT_DIR")"

# Check if Python TUI is available - check source directory first, then WIGGUM_HOME
TUI_VENV=""
TUI_PYTHON=""

find_tui() {
    # Check source directory first (for development/symlink installs)
    if [ -x "$SOURCE_ROOT/tui/.venv/bin/python" ]; then
        TUI_VENV="$SOURCE_ROOT/tui/.venv"
        TUI_PYTHON="$TUI_VENV/bin/python"
        return 0
    fi
    # Fall back to WIGGUM_HOME
    if [ -x "$WIGGUM_HOME/tui/.venv/bin/python" ]; then
        TUI_VENV="$WIGGUM_HOME/tui/.venv"
        TUI_PYTHON="$TUI_VENV/bin/python"
        return 0
    fi
    return 1
}

# Try to find TUI, but don't fail if not available
find_tui || true

tui_available() {
    [ -n "$TUI_PYTHON" ] && [ -x "$TUI_PYTHON" ] && "$TUI_PYTHON" -c "import wiggum_tui" 2>/dev/null
}

show_help() {
    cat << EOF
wiggum monitor - Monitor active worker logs

Usage: wiggum monitor [mode]

Modes:
  tui                 Interactive TUI dashboard (default if available)
  combined            Show all workers in one stream
  split               Show each worker separately
  activity            Tail the JSONL activity log with jq formatting
  status              Continuous status updates

Options:
  -h, --help          Show this help message

Description:
  Monitor the output and progress of active workers in real-time.

  - tui: htop-like interactive dashboard with kanban, workers, logs, metrics
  - combined: Tails the combined workers.log file
  - split: Refreshes every 2 seconds showing last 10 lines per worker
  - status: Runs 'wiggum status' every 2 seconds via watch

Examples:
  wiggum monitor           # Launch TUI dashboard (default)
  wiggum monitor tui       # Explicitly launch TUI
  wiggum monitor combined  # Show combined log stream
  wiggum monitor split     # Show each worker separately
  wiggum monitor status    # Watch status updates

EOF
}

# Parse options
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
    show_help
    exit $EXIT_OK
fi

# Check for .ralph directory
if [ ! -d "$RALPH_DIR" ]; then
    echo "No .ralph directory found. Run 'wiggum init' first."
    exit $EXIT_ERROR
fi

# Determine default mode - use TUI if available, otherwise combined
default_mode="combined"
if tui_available; then
    default_mode="tui"
fi

mode="${1:-$default_mode}"

# Ensure logs directory and workers.log exist for tail -f
mkdir -p "$RALPH_DIR/logs"
touch "$RALPH_DIR/logs/workers.log"

case "$mode" in
    tui)
        # Launch interactive TUI dashboard
        if tui_available; then
            exec "$TUI_PYTHON" -m wiggum_tui
        else
            echo "TUI not available. Install with: cd $SOURCE_ROOT/tui && uv sync"
            echo "Falling back to combined mode..."
            echo
            echo "=== Monitoring Chief Wiggum Workers ==="
            echo "Press Ctrl+C to stop"
            echo
            tail -f "$RALPH_DIR/logs/workers.log"
        fi
        ;;

    combined)
        echo "=== Monitoring Chief Wiggum Workers ==="
        echo "Press Ctrl+C to stop"
        echo
        # Show all worker output combined
        tail -f "$RALPH_DIR/logs/workers.log"
        ;;

    split)
        echo "=== Monitoring Chief Wiggum Workers ==="
        echo "Press Ctrl+C to stop"
        echo
        # Show each worker's latest output
        while true; do
            clear
            for worker_dir in "$RALPH_DIR/workers"/worker-*; do
                if [ -f "$worker_dir/worker.log" ]; then
                    worker_name=$(basename "$worker_dir")
                    echo "=== $worker_name ==="
                    tail -10 "$worker_dir/worker.log" 2>/dev/null
                    echo
                fi
            done
            sleep 2
        done
        ;;

    activity)
        echo "=== Activity Log ==="
        echo "Press Ctrl+C to stop"
        echo
        activity_file="$RALPH_DIR/logs/activity.jsonl"
        if [ ! -f "$activity_file" ]; then
            echo "No activity log found yet. Run 'wiggum run' to generate events."
            exit 0
        fi
        tail -f "$activity_file" | jq '.'
        ;;

    status)
        # Continuous status updates
        watch -n 2 wiggum-status
        ;;

    *)
        echo "Unknown mode: $mode"
        echo ""
        show_help
        exit $EXIT_USAGE
        ;;
esac
