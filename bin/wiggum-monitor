#!/usr/bin/env bash
# Monitor active Chief Wiggum workers

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"
source "$WIGGUM_HOME/lib/exit-codes.sh"
source "$WIGGUM_HOME/lib/defaults.sh"
source "$WIGGUM_HOME/lib/worker-lifecycle.sh"

# Check if Python TUI is available
TUI_VENV="$WIGGUM_HOME/tui/.venv"
TUI_PYTHON="$TUI_VENV/bin/python"

tui_available() {
    [ -x "$TUI_PYTHON" ] && "$TUI_PYTHON" -c "import wiggum_tui" 2>/dev/null
}

show_help() {
    cat << EOF
wiggum monitor - Monitor active worker logs

Usage: wiggum monitor [mode]

Modes:
  tui                 Interactive TUI dashboard (default if available)
  combined            Show all workers in one stream
  split               Show each worker separately
  status              Continuous status updates

Options:
  -h, --help          Show this help message

Description:
  Monitor the output and progress of active workers in real-time.

  - tui: htop-like interactive dashboard with kanban, workers, logs, metrics
  - combined: Tails the combined workers.log file
  - split: Refreshes every 2 seconds showing last 10 lines per worker
  - status: Runs 'wiggum status' every 2 seconds via watch

Examples:
  wiggum monitor           # Launch TUI dashboard (default)
  wiggum monitor tui       # Explicitly launch TUI
  wiggum monitor combined  # Show combined log stream
  wiggum monitor split     # Show each worker separately
  wiggum monitor status    # Watch status updates

EOF
}

# Parse options
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    show_help
    exit $EXIT_OK
fi

# Check for .ralph directory
if [ ! -d "$RALPH_DIR" ]; then
    echo "No .ralph directory found. Run 'wiggum init' first."
    exit $EXIT_ERROR
fi

# For TUI mode, we don't require active workers (can view history)
# For other modes, check for active workers
if [[ "${1:-}" != "tui" ]] && ! tui_available; then
    has_active_workers=false
    if [ -d "$RALPH_DIR/workers" ]; then
        # Use scan_active_workers to check for running workers
        while read -r pid task_id worker_id; do
            if [ -n "$pid" ]; then
                has_active_workers=true
                break
            fi
        done < <(scan_active_workers "$RALPH_DIR")
    fi

    if [ "$has_active_workers" = false ]; then
        echo "No active workers found. Run 'wiggum run' first."
        exit $EXIT_REVIEW_NO_WORKERS
    fi
fi

# Determine default mode - use TUI if available, otherwise combined
default_mode="combined"
if tui_available; then
    default_mode="tui"
fi

mode="${1:-$default_mode}"

case "$mode" in
    tui)
        # Launch interactive TUI dashboard
        if tui_available; then
            exec "$TUI_PYTHON" -m wiggum_tui
        else
            echo "TUI not available. Install with: cd $WIGGUM_HOME/tui && uv sync"
            echo "Falling back to combined mode..."
            echo
            echo "=== Monitoring Chief Wiggum Workers ==="
            echo "Press Ctrl+C to stop"
            echo
            tail -f "$RALPH_DIR/logs/workers.log"
        fi
        ;;

    combined)
        echo "=== Monitoring Chief Wiggum Workers ==="
        echo "Press Ctrl+C to stop"
        echo
        # Show all worker output combined
        tail -f "$RALPH_DIR/logs/workers.log"
        ;;

    split)
        echo "=== Monitoring Chief Wiggum Workers ==="
        echo "Press Ctrl+C to stop"
        echo
        # Show each worker's latest output
        while true; do
            clear
            for worker_dir in "$RALPH_DIR/workers"/worker-*; do
                if [ -f "$worker_dir/worker.log" ]; then
                    worker_name=$(basename "$worker_dir")
                    echo "=== $worker_name ==="
                    tail -10 "$worker_dir/worker.log" 2>/dev/null
                    echo
                fi
            done
            sleep 2
        done
        ;;

    status)
        # Continuous status updates
        watch -n 2 wiggum-status
        ;;

    *)
        echo "Unknown mode: $mode"
        echo ""
        show_help
        exit $EXIT_USAGE
        ;;
esac
