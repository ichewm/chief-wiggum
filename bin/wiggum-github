#!/usr/bin/env bash
# wiggum-github - CLI for GitHub issue sync
#
# Usage:
#   wiggum github                         Full sync cycle (down + up)
#   wiggum github down                    Pull issues -> kanban only
#   wiggum github up                      Push kanban -> GitHub only
#   wiggum github sync up <TASK-ID|all>   Create GitHub issues for untracked tasks
#   wiggum github plan sync [TASK-ID|all] Sync plan files with GitHub issue comments
#   wiggum github status                  Show sync state summary
#   wiggum github init                    Create required GitHub labels and configure sync
#   wiggum github --dry-run               Show planned changes without writing
set -euo pipefail

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"

[ -z "${_WIGGUM_SRC_EXIT_CODES_LOADED:-}" ] && source "$WIGGUM_HOME/lib/core/exit-codes.sh"
[ -z "${_WIGGUM_SRC_DEFAULTS_LOADED:-}" ] && source "$WIGGUM_HOME/lib/core/defaults.sh"
[ -z "${_WIGGUM_SRC_LOGGER_LOADED:-}" ] && source "$WIGGUM_HOME/lib/core/logger.sh"
source "$WIGGUM_HOME/lib/core/verbose-flags.sh"
source "$WIGGUM_HOME/lib/github/issue-config.sh"
source "$WIGGUM_HOME/lib/github/issue-sync.sh"

show_help() {
    cat << EOF
wiggum github - Sync GitHub issues with local kanban

Usage: wiggum github [command] [options]

Commands:
  (none)                       Full sync cycle (down + up)
  init                         Create required GitHub labels and configure sync
  down                         Pull GitHub issues to local kanban only
  up                           Push local kanban status to GitHub only
  sync up <TASK-ID|all> [-y]   Create GitHub issues for untracked kanban tasks
  plan sync [TASK-ID|all]      Sync plan files with GitHub issue comments
  status                       Show sync state summary

Options:
  --dry-run              Show planned changes without writing
  --force up|down        Resolve plan sync conflicts (up=local wins, down=remote wins)
  -y                     Skip confirmation prompt (for sync up)
  -h, --help             Show this help

Examples:
  wiggum github init                         # Set up labels and configuration
  wiggum github init --dry-run               # Preview labels without creating
  wiggum github                              # Full sync
  wiggum github down                         # Import new issues
  wiggum github up                           # Push status changes
  wiggum github sync up TASK-333             # Create issue for one task
  wiggum github sync up all                  # Create issues for all untracked
  wiggum github sync up all -y               # Skip confirmation
  wiggum github plan sync                    # Sync non-terminal plans
  wiggum github plan sync all                # Sync all plans (including completed)
  wiggum github plan sync TASK-001           # Sync one task's plan
  wiggum github plan sync --dry-run          # Preview plan sync changes
  wiggum github plan sync --force up         # Push local plans (resolve conflicts)
  wiggum github plan sync --force down       # Pull remote plans (resolve conflicts)
  wiggum github --dry-run                    # Preview changes
  wiggum github status                       # Show state

Configuration:
  Set in .ralph/config.json or config/config.json under github.issue_sync.
  Enable with: "enabled": true
  Required: allowed_user_ids must be configured.

Environment:
  WIGGUM_GITHUB_ISSUE_SYNC=true        Enable sync
  WIGGUM_GITHUB_ALLOWED_USER_IDS=...   Comma-separated user IDs
  WIGGUM_GITHUB_LABEL_FILTER=wiggum    Gate label (default: wiggum)

EOF
}

# =============================================================================
# GitHub Init - Create labels and configure sync
# =============================================================================

# Label definitions: name|color|description
GITHUB_LABELS=(
    # Gate label (required for sync)
    "wiggum|0052cc|Chief Wiggum managed task"
    # Status labels
    "wiggum:in-progress|fbca04|Task is being worked on"
    "wiggum:pending-approval|d4c5f9|Task awaiting review/approval"
    "wiggum:completed|0e8a16|Task completed successfully"
    "wiggum:failed|d93f0b|Task failed"
    "wiggum:resume-request|ff69b4|Request resume of failed task"
    "wiggum:not-planned|c0c0c0|Task will not be implemented"
    # Priority labels
    "priority:critical|b60205|Highest priority - immediate attention"
    "priority:high|d93f0b|High priority"
    "priority:medium|fbca04|Medium priority (default)"
    "priority:low|c2e0c6|Low priority"
    # Complexity labels
    "complexity:high|5319e7|High complexity task"
    "complexity:medium|1d76db|Medium complexity task"
    "complexity:low|bfd4f2|Low complexity task"
)

# Create a single GitHub label
#
# Args:
#   label_spec - "name|color|description"
#   dry_run    - "true" to only print what would be done
#
# Returns: 0 on success or if label exists, 1 on error
github_create_label() {
    local label_spec="$1"
    local dry_run="${2:-false}"

    local name color description
    IFS='|' read -r name color description <<< "$label_spec"

    if [ "$dry_run" = "true" ]; then
        echo "  [dry-run] Would create label: $name (#$color)"
        return 0
    fi

    # Check if label exists
    local exit_code=0
    if gh label list --search "$name" --json name -q ".[].name" 2>/dev/null | grep -qx "$name"; then
        echo "  Label exists: $name"
        return 0
    fi

    # Create the label
    gh label create "$name" --color "$color" --description "$description" 2>/dev/null || exit_code=$?

    if [ "$exit_code" -eq 0 ]; then
        echo "  Created label: $name (#$color)"
    else
        echo "  Failed to create label: $name (exit: $exit_code)" >&2
        return 1
    fi
    return 0
}

# Initialize GitHub integration for Chief Wiggum
#
# Creates required labels and optionally configures sync settings.
#
# Args:
#   dry_run - "true" to only show what would be done
#
# Returns: 0 on success, 1 on error
github_init() {
    local dry_run="${1:-false}"

    echo "Chief Wiggum GitHub Integration Setup"
    echo "======================================"
    echo ""

    # Check prerequisites
    echo "Checking prerequisites..."

    # 1. Check gh CLI
    if ! command -v gh &>/dev/null; then
        echo "  ERROR: GitHub CLI (gh) not found."
        echo "  Install from: https://cli.github.com/"
        return 1
    fi
    echo "  gh CLI: found"

    # 2. Check gh authentication
    if ! gh auth status &>/dev/null; then
        echo "  ERROR: Not authenticated with GitHub."
        echo "  Run: gh auth login"
        return 1
    fi
    echo "  gh auth: authenticated"

    # 3. Check if in a GitHub repo
    local repo_info
    repo_info=$(gh repo view --json nameWithOwner -q '.nameWithOwner' 2>/dev/null) || true
    if [ -z "$repo_info" ]; then
        echo "  ERROR: Not in a GitHub repository."
        echo "  Ensure this directory is a git repo with a GitHub remote."
        return 1
    fi
    echo "  Repository: $repo_info"

    # 4. Check .ralph directory
    if [ ! -d "$RALPH_DIR" ]; then
        echo ""
        echo "  WARNING: .ralph directory not found."
        echo "  Run 'wiggum init' first to create project structure."
        echo ""
    fi

    echo ""
    echo "Creating labels..."

    # Create all labels
    local label_spec
    local errors=0
    for label_spec in "${GITHUB_LABELS[@]}"; do
        github_create_label "$label_spec" "$dry_run" || ((++errors)) || true
    done

    if [ "$errors" -gt 0 ]; then
        echo ""
        echo "WARNING: $errors label(s) failed to create."
    fi

    echo ""

    if [ "$dry_run" = "true" ]; then
        echo "[dry-run] No changes made."
        return 0
    fi

    # Offer to configure sync
    echo "Labels created successfully!"
    echo ""
    echo "Next steps to enable GitHub sync:"
    echo ""
    echo "  1. Get your GitHub user ID:"
    echo "     gh api user --jq '.id'"
    echo ""
    echo "  2. Add to .ralph/config.json:"
    echo '     {'
    echo '       "github": {'
    echo '         "issue_sync": {'
    echo '           "enabled": true,'
    echo '           "allowed_user_ids": [YOUR_USER_ID]'
    echo '         }'
    echo '       }'
    echo '     }'
    echo ""
    echo "  3. Add the 'wiggum' label to issues you want Chief Wiggum to manage."
    echo ""
    echo "  4. Run 'wiggum github down' to import labeled issues."
    echo ""

    return 0
}

main() {
    # Parse verbose flags first
    parse_verbose_flags "$@"
    set -- "${WIGGUM_REMAINING_ARGS[@]}"

    local command=""
    local dry_run="false"
    local skip_confirm="false"
    local sync_target=""
    local plan_sync_task_id=""
    local force_direction=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit $EXIT_OK
                ;;
            --dry-run)
                dry_run="true"
                shift
                ;;
            -y)
                skip_confirm="true"
                shift
                ;;
            plan)
                # Handle "plan-sync [TASK-ID] [--force up|down]"
                shift
                if [[ $# -gt 0 ]] && [[ "$1" == "sync" ]]; then
                    command="plan-sync"
                    shift
                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            --dry-run)
                                dry_run="true"; shift ;;
                            --force)
                                if [[ $# -lt 2 ]]; then
                                    echo "Error: --force requires 'up' or 'down'" >&2
                                    exit $EXIT_USAGE
                                fi
                                force_direction="$2"; shift 2 ;;
                            -h|--help)
                                show_help; exit $EXIT_OK ;;
                            -*)
                                echo "Unknown option: $1" >&2
                                exit $EXIT_USAGE ;;
                            *)
                                plan_sync_task_id="$1"; shift ;;
                        esac
                    done
                else
                    echo "Error: Unknown plan subcommand. Use 'plan-sync [TASK-ID]'" >&2
                    exit $EXIT_USAGE
                fi
                ;;
            sync)
                # Handle "sync up <target>"
                shift
                if [[ $# -gt 0 ]] && [[ "$1" == "up" ]]; then
                    command="sync-up"
                    shift
                    if [[ $# -gt 0 ]] && [[ "$1" != -* ]]; then
                        sync_target="$1"
                        shift
                    else
                        echo "Error: 'sync up' requires a task ID or 'all'" >&2
                        echo "Usage: wiggum github sync up <TASK-ID|all> [-y]" >&2
                        exit $EXIT_USAGE
                    fi
                else
                    echo "Error: Unknown sync subcommand. Use 'sync up <TASK-ID|all>'" >&2
                    exit $EXIT_USAGE
                fi
                ;;
            down|up|status|init)
                command="$1"
                shift
                ;;
            *)
                echo "Unknown argument: $1" >&2
                show_help
                exit $EXIT_USAGE
                ;;
        esac
    done

    # Init command has special handling (doesn't require existing config)
    if [ "$command" = "init" ]; then
        github_init "$dry_run"
        exit $?
    fi

    # Verify ralph directory
    if [ ! -d "$RALPH_DIR" ]; then
        log_error "Ralph directory not found: $RALPH_DIR"
        echo "Run 'wiggum init' first."
        exit $EXIT_RUN_NO_RALPH_DIR
    fi

    # Load and validate config
    load_github_sync_config

    if ! github_sync_is_enabled; then
        echo "GitHub issue sync is disabled."
        echo "Enable it in .ralph/config.json: {\"github\": {\"issue_sync\": {\"enabled\": true}}}"
        echo "Or set: WIGGUM_GITHUB_ISSUE_SYNC=true"
        exit $EXIT_OK
    fi

    if ! github_sync_validate_config; then
        log_error "GitHub sync configuration is invalid"
        exit $EXIT_ERROR
    fi

    # Dispatch command
    case "${command:-}" in
        ""|down|up|sync-up|plan-sync)
            if [ "$dry_run" = "true" ]; then
                echo "=== Dry Run Mode ==="
                echo ""
            fi
            ;;
    esac

    case "${command:-}" in
        "")
            # Full sync
            github_issue_sync "$RALPH_DIR" "$dry_run"
            ;;
        down)
            github_issue_sync_down "$RALPH_DIR" "$dry_run"
            ;;
        up)
            github_issue_sync_up "$RALPH_DIR" "$dry_run"
            ;;
        sync-up)
            github_issue_sync_up_create "$RALPH_DIR" "$sync_target" "$dry_run" "$skip_confirm"
            ;;
        plan-sync)
            source "$WIGGUM_HOME/lib/github/plan-sync.sh"
            github_plan_sync "$RALPH_DIR" "$plan_sync_task_id" "$dry_run" "$force_direction"
            ;;
        status)
            github_issue_sync_status "$RALPH_DIR"
            ;;
    esac
}

main "$@"
