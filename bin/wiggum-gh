#!/usr/bin/env bash
# wiggum-gh - CLI for GitHub issue sync
#
# Usage:
#   wiggum gh                         Full sync cycle (down + up)
#   wiggum gh down                    Pull issues -> kanban only
#   wiggum gh up                      Push kanban -> GitHub only
#   wiggum gh sync up <TASK-ID|all>   Create GitHub issues for untracked tasks
#   wiggum gh status                  Show sync state summary
#   wiggum gh --dry-run               Show planned changes without writing
set -euo pipefail

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"

source "$WIGGUM_HOME/lib/core/exit-codes.sh"
source "$WIGGUM_HOME/lib/core/defaults.sh"
source "$WIGGUM_HOME/lib/core/logger.sh"
source "$WIGGUM_HOME/lib/core/verbose-flags.sh"
source "$WIGGUM_HOME/lib/github/issue-config.sh"
source "$WIGGUM_HOME/lib/github/issue-sync.sh"

show_help() {
    cat << EOF
wiggum gh - Sync GitHub issues with local kanban

Usage: wiggum gh [command] [options]

Commands:
  (none)                       Full sync cycle (down + up)
  down                         Pull GitHub issues to local kanban only
  up                           Push local kanban status to GitHub only
  sync up <TASK-ID|all> [-y]   Create GitHub issues for untracked kanban tasks
  status                       Show sync state summary

Options:
  --dry-run    Show planned changes without writing
  -y           Skip confirmation prompt (for sync up)
  -h, --help   Show this help

Examples:
  wiggum gh                         # Full sync
  wiggum gh down                    # Import new issues
  wiggum gh up                      # Push status changes
  wiggum gh sync up TASK-333        # Create issue for one task
  wiggum gh sync up all             # Create issues for all untracked
  wiggum gh sync up all -y          # Skip confirmation
  wiggum gh --dry-run               # Preview changes
  wiggum gh status                  # Show state

Configuration:
  Set in .ralph/config.json or config/config.json under github.issue_sync.
  Enable with: "enabled": true
  Required: allowed_user_ids must be configured.

Environment:
  WIGGUM_GITHUB_ISSUE_SYNC=true        Enable sync
  WIGGUM_GITHUB_ALLOWED_USER_IDS=...   Comma-separated user IDs
  WIGGUM_GITHUB_LABEL_FILTER=wiggum    Gate label (default: wiggum)

EOF
}

main() {
    # Parse verbose flags first
    parse_verbose_flags "$@"
    set -- "${WIGGUM_REMAINING_ARGS[@]}"

    local command=""
    local dry_run="false"
    local skip_confirm="false"
    local sync_target=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit $EXIT_OK
                ;;
            --dry-run)
                dry_run="true"
                shift
                ;;
            -y)
                skip_confirm="true"
                shift
                ;;
            sync)
                # Handle "sync up <target>"
                shift
                if [[ $# -gt 0 ]] && [[ "$1" == "up" ]]; then
                    command="sync-up"
                    shift
                    if [[ $# -gt 0 ]] && [[ "$1" != -* ]]; then
                        sync_target="$1"
                        shift
                    else
                        echo "Error: 'sync up' requires a task ID or 'all'" >&2
                        echo "Usage: wiggum gh sync up <TASK-ID|all> [-y]" >&2
                        exit $EXIT_USAGE
                    fi
                else
                    echo "Error: Unknown sync subcommand. Use 'sync up <TASK-ID|all>'" >&2
                    exit $EXIT_USAGE
                fi
                ;;
            down|up|status)
                command="$1"
                shift
                ;;
            *)
                echo "Unknown argument: $1" >&2
                show_help
                exit $EXIT_USAGE
                ;;
        esac
    done

    # Verify ralph directory
    if [ ! -d "$RALPH_DIR" ]; then
        log_error "Ralph directory not found: $RALPH_DIR"
        echo "Run 'wiggum init' first."
        exit $EXIT_RUN_NO_RALPH_DIR
    fi

    # Load and validate config
    load_github_sync_config

    if ! github_sync_is_enabled; then
        echo "GitHub issue sync is disabled."
        echo "Enable it in .ralph/config.json: {\"github\": {\"issue_sync\": {\"enabled\": true}}}"
        echo "Or set: WIGGUM_GITHUB_ISSUE_SYNC=true"
        exit $EXIT_OK
    fi

    if ! github_sync_validate_config; then
        log_error "GitHub sync configuration is invalid"
        exit $EXIT_ERROR
    fi

    # Dispatch command
    case "${command:-}" in
        ""|down|up|sync-up)
            if [ "$dry_run" = "true" ]; then
                echo "=== Dry Run Mode ==="
                echo ""
            fi
            ;;
    esac

    case "${command:-}" in
        "")
            # Full sync
            github_issue_sync "$RALPH_DIR" "$dry_run"
            ;;
        down)
            github_issue_sync_down "$RALPH_DIR" "$dry_run"
            ;;
        up)
            github_issue_sync_up "$RALPH_DIR" "$dry_run"
            ;;
        sync-up)
            github_issue_sync_up_create "$RALPH_DIR" "$sync_target" "$dry_run" "$skip_confirm"
            ;;
        status)
            github_issue_sync_status "$RALPH_DIR"
            ;;
    esac
}

main "$@"
