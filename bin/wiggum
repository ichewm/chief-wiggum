#!/usr/bin/env bash
# Chief Wiggum - Autonomous Worker Orchestration
set -euo pipefail

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"

[ -z "${_WIGGUM_SRC_EXIT_CODES_LOADED:-}" ] && source "$WIGGUM_HOME/lib/core/exit-codes.sh"
source "$WIGGUM_HOME/lib/core/verbose-flags.sh"

# Print deprecation warning and forward
_deprecated() {
    local old="$1" new="$2"
    echo "Warning: 'wiggum $old' is deprecated, use 'wiggum $new' instead." >&2
}

show_help() {
    cat << 'EOF'
Chief Wiggum - Autonomous Worker Orchestration

Usage: wiggum [flags] <command> [options]

Setup & Health:
  init                Initialize .ralph/ directory
  validate            Validate kanban.md format
  doctor              Check environment setup

Core Workflow:
  run                 Orchestrate workers for tasks
  plan <ID>           Create implementation plan
  status              Show worker/task status
  monitor             Monitor workers in real-time

Worker Management:
  worker start <ID>   Start a new worker
  worker stop [<ID>]  Stop worker(s) gracefully
  worker kill <ID>    Force kill worker(s)
  worker resume <ID>  Resume a stopped worker
  worker fix <ID>     Fix PR review comments
  worker merge <ID>   Merge a task's PR

Pull Requests:
  pr list             List open worker PRs
  pr sync             Sync PR status and comments
  pr view <PR#>       View a PR with diff
  pr merge <PR#>      Merge a specific PR
  pr create <ID>      Create PR for worker branch
  pr resolve <ID>     Resolve merge conflicts

Cleanup & Debug:
  clean <target>      Clean workspaces/logs/tasks
  inspect <target>    Debug workers, pipelines, agents

Integration:
  github <action>     Sync GitHub issues with kanban
  service <action>    Manage orchestrator services
  failure-recovery    Recover failed workers

Global Flags:
  -v/--verbose  -vv  -vvv  -q/--quiet

Run 'wiggum <command> --help' for details.

EOF
}

main() {
    # Parse verbose flags first (before command)
    # This sets LOG_LEVEL and removes verbose flags from args
    parse_verbose_flags "$@"
    set -- "${WIGGUM_REMAINING_ARGS[@]}"

    # Require a command
    if [ $# -eq 0 ]; then
        echo "Error: No command specified"
        echo ""
        show_help
        exit $EXIT_USAGE
    fi

    # Parse command
    local command="$1"
    shift

    case "$command" in
        # Unchanged
        init)
            exec "$WIGGUM_HOME/bin/wiggum-init" "$@"
            ;;
        validate)
            exec "$WIGGUM_HOME/bin/wiggum-validate" "$@"
            ;;
        run)
            exec "$WIGGUM_HOME/bin/wiggum-run" "$@"
            ;;
        plan)
            exec "$WIGGUM_HOME/bin/wiggum-plan" "$@"
            ;;
        status)
            exec "$WIGGUM_HOME/bin/wiggum-status" "$@"
            ;;
        monitor)
            exec "$WIGGUM_HOME/bin/wiggum-monitor" "$@"
            ;;
        doctor)
            exec "$WIGGUM_HOME/bin/wiggum-doctor" "$@"
            ;;
        clean)
            exec "$WIGGUM_HOME/bin/wiggum-clean" "$@"
            ;;
        inspect)
            exec "$WIGGUM_HOME/bin/wiggum-inspect" "$@"
            ;;
        service)
            exec "$WIGGUM_HOME/bin/wiggum-service" "$@"
            ;;
        failure-recovery)
            exec "$WIGGUM_HOME/bin/wiggum-failure-recovery" "$@"
            ;;

        # New groups
        worker)
            exec "$WIGGUM_HOME/bin/wiggum-worker" "$@"
            ;;
        pr)
            exec "$WIGGUM_HOME/bin/wiggum-pr" "$@"
            ;;
        github)
            exec "$WIGGUM_HOME/bin/wiggum-github" "$@"
            ;;

        # Deprecated aliases (warn + forward)
        start)
            _deprecated "start" "worker start"
            exec "$WIGGUM_HOME/bin/wiggum-worker" start "$@"
            ;;
        stop)
            _deprecated "stop" "worker stop"
            exec "$WIGGUM_HOME/bin/wiggum-worker" stop "$@"
            ;;
        kill)
            _deprecated "kill" "worker kill"
            exec "$WIGGUM_HOME/bin/wiggum-worker" kill "$@"
            ;;
        resume)
            _deprecated "resume" "worker resume"
            exec "$WIGGUM_HOME/bin/wiggum-worker" resume "$@"
            ;;
        review)
            _deprecated "review" "pr"
            exec "$WIGGUM_HOME/bin/wiggum-pr" "$@"
            ;;
        gh)
            _deprecated "gh" "github"
            exec "$WIGGUM_HOME/bin/wiggum-github" "$@"
            ;;
        util)
            _deprecated "util" "inspect"
            # Translate 'util convert-log' -> 'inspect log'
            if [ "${1:-}" = "convert-log" ]; then
                shift
                exec "$WIGGUM_HOME/bin/wiggum-inspect" log "$@"
            fi
            exec "$WIGGUM_HOME/bin/wiggum-inspect" "$@"
            ;;

        -h|--help|help)
            show_help
            exit $EXIT_OK
            ;;
        *)
            echo "Unknown command: $command"
            echo ""
            show_help
            exit $EXIT_USAGE
            ;;
    esac
}

main "$@"
