#!/usr/bin/env bash
# wiggum stop - Stop workers or orchestrator
#
# Usage:
#   wiggum stop                 Stop all workers
#   wiggum stop <id>            Stop specific worker by ID/pattern
#   wiggum stop orchestrator    Stop the orchestrator process

set -euo pipefail

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"
source "$WIGGUM_HOME/lib/core/bin-common.sh"
source "$WIGGUM_HOME/lib/worker/worker-lifecycle.sh"

show_help() {
    cat << EOF
wiggum stop - Stop workers or orchestrator

Usage:
  wiggum stop                 Stop all workers
  wiggum stop <id>            Stop specific worker by ID/pattern
  wiggum stop orchestrator    Stop the orchestrator process

Worker ID Resolution:
  Worker IDs can be partial as long as they match exactly one worker:
  - 1891712              (timestamp)
  - K-030                (partial task ID)
  - TASK-030             (task ID)
  - worker-TASK-030-1891712  (full ID)

Options:
  -v, --verbose   Verbose output (same as default)
  -vv             Debug output (detailed diagnostics)
  -vvv            Trace output (very detailed tracing)
  -q, --quiet     Quiet mode (warnings and errors only)
  -h, --help      Show this help message

Examples:
  wiggum stop                 # Stop all workers
  wiggum stop TASK-030        # Stop worker for TASK-030
  wiggum stop 1891712         # Stop worker by timestamp
  wiggum stop orchestrator    # Stop the orchestrator

EOF
}

# Stop the orchestrator
stop_orchestrator() {
    local orchestrator_lock="$RALPH_DIR/orchestrator/orchestrator.pid"

    if [ ! -f "$orchestrator_lock" ]; then
        echo "No orchestrator process running"
        exit $EXIT_OK
    fi

    local orchestrator_pid
    orchestrator_pid=$(cat "$orchestrator_lock" 2>/dev/null)

    if ! [[ "$orchestrator_pid" =~ ^[0-9]+$ ]]; then
        echo "Invalid orchestrator PID, cleaning lock file"
        rm -f "$orchestrator_lock"
        exit $EXIT_OK
    fi

    if kill -0 "$orchestrator_pid" 2>/dev/null; then
        if ps -p "$orchestrator_pid" -o args= 2>/dev/null | grep -q "wiggum-run"; then
            echo "Stopping orchestrator (PID: $orchestrator_pid)..."
            kill -TERM "$orchestrator_pid"
            echo "Orchestrator stopped"
        else
            echo "Process $orchestrator_pid is not wiggum-run (PID reused?)"
            rm -f "$orchestrator_lock"
        fi
    else
        echo "Orchestrator process not running, cleaning stale lock"
        rm -f "$orchestrator_lock"
    fi
    exit $EXIT_OK
}

# Main
main() {
    # Parse verbose flags first
    parse_verbose_flags "$@"
    set -- "${WIGGUM_REMAINING_ARGS[@]}"

    if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
        show_help
        exit $EXIT_OK
    fi

    # No arguments = stop all workers
    if [ $# -eq 0 ]; then
        if [ ! -d "$RALPH_DIR/workers" ]; then
            echo "No wiggum workers found"
            exit $EXIT_OK
        fi

        echo "Stopping all workers..."
        terminate_all_workers "$RALPH_DIR" TERM 10

        if [ "$TERMINATE_ALL_FAILED" -gt 0 ]; then
            echo "Warning: $TERMINATE_ALL_FAILED workers did not stop gracefully, force killing..."
            force_kill_remaining_workers "$RALPH_DIR" > /dev/null
        fi

        echo "Stopped $TERMINATE_ALL_COUNT workers"
        exit $EXIT_OK
    fi

    local target="$1"

    # Special target: orchestrator
    if [ "$target" = "orchestrator" ]; then
        stop_orchestrator
    fi

    # Resolve worker ID pattern
    local worker_dir
    worker_dir=$(resolve_worker_id "$RALPH_DIR" "$target") || exit $EXIT_ERROR

    if terminate_single_worker "$worker_dir" TERM 30; then
        echo "Worker $TERMINATE_WORKER_ID stopped successfully"
    else
        echo "Warning: Worker did not stop gracefully within 30s"
        echo "Use 'wiggum kill $TERMINATE_WORKER_ID' to force terminate"
        exit 1
    fi
}

main "$@"
