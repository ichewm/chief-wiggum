#!/usr/bin/env bash
# Review and manage worker PRs using gh CLI

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"
source "$WIGGUM_HOME/lib/exit-codes.sh"
source "$WIGGUM_HOME/lib/defaults.sh"
source "$WIGGUM_HOME/lib/pr-comments.sh"
source "$WIGGUM_HOME/lib/agent-registry.sh"

show_help() {
    cat << EOF
wiggum review - Review and manage worker Pull Requests

Usage: wiggum review [command] [options]

Commands:
  list                      List all open worker PRs
  pr [PR#] view             View a specific PR with diff
  pr [PR#] merge            Merge a specific PR
  merge-all                 Merge all worker PRs (with confirmation)
  cleanup                   Delete merged branches
  status                    Show integration status
  task <patterns> sync      Sync PR comments for tasks matching patterns
  task <patterns> fix       Fix PR comments using ralph loop

Options:
  -h, --help        Show this help message
  --auto-merge      Auto-merge without confirmation (use with caution)
  --squash          Squash commits when merging
  --rebase          Rebase instead of merge

Task Pattern Examples:
  TASK-030                  Single task
  TASK-030,TASK-031         Multiple tasks (comma-separated)

Environment Variables:
  WIGGUM_APPROVED_AUTHORS           Comma-separated list of comment authors to include
                                    (default: copilot,dependabot,github-actions[bot],...)
  WIGGUM_COMMENT_FIX_MAX_ITERATIONS Maximum fix loop iterations (default: 10)
  WIGGUM_COMMENT_FIX_MAX_TURNS      Max turns per fix session (default: 30)
  WIGGUM_AUTO_COMMIT_AFTER_FIX      Auto commit/push after fix (default: true)

Examples:
  wiggum review list                    # List all worker PRs
  wiggum review pr 42 view              # Review PR #42
  wiggum review pr 42 merge             # Merge PR #42
  wiggum review pr 42 merge --squash    # Squash-merge PR #42
  wiggum review merge-all               # Merge all worker PRs (with confirmation)
  wiggum review merge-all --auto-merge  # Auto-merge all without asking
  wiggum review cleanup                 # Delete merged branches
  wiggum review task TASK-030 sync      # Sync comments for TASK-030
  wiggum review task TASK-030,TASK-031 sync  # Sync multiple tasks
  wiggum review task TASK-030 fix       # Fix synced comments

EOF
}

log() {
    echo "[$(date -Iseconds)] $*"
}

error() {
    echo "[$(date -Iseconds)] ERROR: $*" >&2
}

# Check if gh CLI is installed
if ! command -v gh &> /dev/null; then
    error "gh CLI is not installed. Install it from: https://cli.github.com/"
    exit $EXIT_ERROR
fi

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    error "Not in a git repository"
    exit $EXIT_REVIEW_NO_RALPH_DIR
fi

list_worker_prs() {
    log "Listing worker Pull Requests..."
    gh pr list --label "chief-wiggum" --state open 2>/dev/null || \
    gh pr list --search "Chief Wiggum in:title" --state open 2>/dev/null || \
    gh pr list --search "task/ in:head" --state open
}

review_pr() {
    local pr_number="$1"

    if [ -z "$pr_number" ]; then
        error "PR number required"
        return 1
    fi

    log "Reviewing PR #$pr_number..."
    echo ""
    gh pr view "$pr_number"
    echo ""
    echo "=== DIFF ==="
    gh pr diff "$pr_number"
}

merge_pr() {
    local pr_number="$1"
    local merge_method="${2:-merge}"  # merge, squash, or rebase

    if [ -z "$pr_number" ]; then
        error "PR number required"
        return 1
    fi

    log "Merging PR #$pr_number using $merge_method..."

    local merge_flag=""
    case "$merge_method" in
        squash)
            merge_flag="--squash"
            ;;
        rebase)
            merge_flag="--rebase"
            ;;
        merge)
            merge_flag="--merge"
            ;;
    esac

    if gh pr merge "$pr_number" $merge_flag --delete-branch; then
        log "✓ Merged PR #$pr_number"
        return 0
    else
        error "Failed to merge PR #$pr_number"
        return 1
    fi
}

merge_all_prs() {
    local auto_merge="$1"
    local merge_method="$2"

    log "Finding all worker PRs..."

    # Get list of PR numbers
    local pr_numbers=$(gh pr list --search "task/ in:head" --state open --json number -q '.[].number')

    if [ -z "$pr_numbers" ]; then
        log "No worker PRs found to merge"
        return 0
    fi

    local pr_count=$(echo "$pr_numbers" | wc -l)
    log "Found $pr_count worker PR(s) to merge"

    echo ""
    gh pr list --search "task/ in:head" --state open
    echo ""

    if [ "$auto_merge" != "true" ]; then
        read -p "Merge all $pr_count PR(s)? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log "Cancelled"
            return 0
        fi
    fi

    local merged=0
    local failed=0

    for pr in $pr_numbers; do
        if merge_pr "$pr" "$merge_method"; then
            ((merged++))
        else
            ((failed++))
        fi
    done

    log "Merge complete: $merged successful, $failed failed"

    if [ $merged -gt 0 ]; then
        log "Pulling changes to local main branch..."
        git checkout main
        git pull
    fi
}

cleanup_branches() {
    log "Cleaning up merged branches..."

    # Find branches that match task/* pattern and are merged
    local merged_branches=$(git branch -r --merged main | grep 'origin/task/' | sed 's/origin\///')

    if [ -z "$merged_branches" ]; then
        log "No merged task branches to clean up"
        return 0
    fi

    log "Found merged branches:"
    echo "$merged_branches"
    echo ""

    read -p "Delete these branches from remote? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log "Cancelled"
        return 0
    fi

    for branch in $merged_branches; do
        log "Deleting remote branch: $branch"
        git push origin --delete "$branch" || true
    done

    log "✓ Cleanup complete"
}

show_status() {
    log "Chief Wiggum Review Status"
    echo ""

    echo "=== Open Worker PRs ==="
    gh pr list --search "task/ in:head" --state open || echo "No open PRs"
    echo ""

    echo "=== Recently Merged Worker PRs ==="
    gh pr list --search "task/ in:head" --state merged --limit 5 || echo "No merged PRs"
    echo ""

    echo "=== Local Branch Status ==="
    local current_branch=$(git rev-parse --abbrev-ref HEAD)
    echo "Current branch: $current_branch"

    if [ "$current_branch" = "main" ]; then
        git status -sb
    else
        echo "Not on main branch. Switch to main and pull to integrate changes."
    fi
}

# Sync PR comments for task patterns
cmd_task_sync() {
    local patterns="$1"

    if [ -z "$patterns" ]; then
        error "Task pattern(s) required"
        echo "Usage: wiggum review task <patterns> sync"
        return 1
    fi

    # Determine output directory
    # Use the worker directory if one exists for the pattern, else use .ralph/review/
    local output_dir="$RALPH_DIR/review"

    # Try to find existing worker for primary pattern
    local primary_pattern=$(echo "$patterns" | cut -d',' -f1)
    local worker_dir=$(find_worker_by_task_id "$RALPH_DIR" "$primary_pattern" 2>/dev/null)

    if [ -n "$worker_dir" ] && [ -d "$worker_dir" ]; then
        output_dir="$worker_dir"
        log "Using worker directory: $output_dir"
    else
        mkdir -p "$output_dir"
        log "Using review directory: $output_dir"
    fi

    sync_pr_comments "$patterns" "$output_dir"
}

# Fix PR comments for a task
cmd_task_fix() {
    local pattern="$1"

    if [ -z "$pattern" ]; then
        error "Task pattern required"
        echo "Usage: wiggum review task <pattern> fix"
        return 1
    fi

    # Find worker directory for this task
    local worker_dir=$(find_worker_by_task_id "$RALPH_DIR" "$pattern")

    if [ -z "$worker_dir" ] || [ ! -d "$worker_dir" ]; then
        # Try the review directory as fallback
        worker_dir="$RALPH_DIR/review"
        if [ ! -f "$worker_dir/task-comments.md" ]; then
            error "No worker or review directory found for pattern: $pattern"
            echo "Ensure a worker exists for this task or run sync first:"
            echo "  wiggum review task $pattern sync"
            return 1
        fi
        log "Using review directory: $worker_dir"
    fi

    # Verify comments file exists
    if [ ! -f "$worker_dir/task-comments.md" ]; then
        error "No comments file found. Run sync first:"
        echo "  wiggum review task $pattern sync"
        return 1
    fi

    log "Starting comment fix loop for $(basename "$worker_dir")"
    run_agent "pr-comment-fix" "$worker_dir" "$(pwd)"
}

# Parse arguments
AUTO_MERGE=false
MERGE_METHOD="merge"
COMMAND="${1:-list}"

shift 2>/dev/null || true

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit $EXIT_OK
            ;;
        --auto-merge)
            AUTO_MERGE=true
            shift
            ;;
        --squash)
            MERGE_METHOD="squash"
            shift
            ;;
        --rebase)
            MERGE_METHOD="rebase"
            shift
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

# Execute command
case "$COMMAND" in
    list)
        list_worker_prs
        ;;
    pr)
        PR_NUMBER="${ARGS[0]}"
        PR_ACTION="${ARGS[1]}"
        if [ -z "$PR_NUMBER" ]; then
            error "PR number required"
            echo "Usage: wiggum review pr [PR#] [view|merge]"
            exit $EXIT_USAGE
        fi
        if [ -z "$PR_ACTION" ]; then
            error "Action required"
            echo "Usage: wiggum review pr [PR#] [view|merge]"
            exit $EXIT_USAGE
        fi
        case "$PR_ACTION" in
            view)
                review_pr "$PR_NUMBER"
                ;;
            merge)
                merge_pr "$PR_NUMBER" "$MERGE_METHOD"
                ;;
            *)
                error "Unknown PR action: $PR_ACTION"
                echo "Usage: wiggum review pr [PR#] [view|merge]"
                exit $EXIT_USAGE
                ;;
        esac
        ;;
    task)
        TASK_PATTERNS="${ARGS[0]}"
        TASK_ACTION="${ARGS[1]}"

        if [ -z "$TASK_PATTERNS" ]; then
            error "Task pattern(s) required"
            echo "Usage: wiggum review task <patterns> [sync|fix]"
            exit $EXIT_USAGE
        fi

        case "${TASK_ACTION:-sync}" in
            sync)
                cmd_task_sync "$TASK_PATTERNS"
                ;;
            fix)
                cmd_task_fix "$TASK_PATTERNS"
                ;;
            *)
                error "Unknown task action: $TASK_ACTION"
                echo "Valid actions: sync, fix"
                exit $EXIT_USAGE
                ;;
        esac
        ;;
    merge-all)
        merge_all_prs "$AUTO_MERGE" "$MERGE_METHOD"
        ;;
    cleanup)
        cleanup_branches
        ;;
    status)
        show_status
        ;;
    -h|--help)
        show_help
        ;;
    *)
        error "Unknown command: $COMMAND"
        echo ""
        show_help
        exit $EXIT_USAGE
        ;;
esac
